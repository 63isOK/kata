# 15格拼图游戏

## 问题

实现一个15格的拼图游戏

15格的拼图游戏是什么:

- 在一个4x4的拼盘里有15个小块,要把她们排好

## 设计思路

- 先考虑4x4的拼盘,更大的拼盘作为重构的考虑部分
- 需要设计一个拼盘类,要支持以下操作
  - 初始的随机处理
  - 拼块的上下左右移动
  - 成功的检测,简单点就是每次移动检测,进一步是空块在最后检测
  - 拼盘接收事件,而事件的触发应该支持键盘/鼠标/触摸,未来可能支持人脸/语音
- 基于console显示时,使用main来调用
- 基于web或其他显示时,再单独做界面
- 从拼盘类的使用上看
  - 应该有个默认拼盘
  - 通过默认拼盘,应该对外暴露拼盘支持的能力
  - 那么应该还需要有个接口,用来产生事件,就如人脸或语音
    - 实际场景中,应该还需要配置哪些生成事件的对象可用,不过这不属于拼盘

总的来说,针对这个题意,主要还是拼盘类的封装

## 详细设计中的坑

在总体设计思路的框架下,进一步细化了具体的设计,包括:

- 每次接收到移动命令,会更新一下坐标
  - 主要是考虑部分场景,应用程序更加需要坐标的变化
- 拼盘变化后,有两种方式通知应用程序

安装上面的思路,将整个代码实现,过程中出现了以下几个问题:
对外暴露了一个Data()来获取拼盘数据,Position()来获取坐标信息,
但在单元测试中这两种方法都用到了,同时移动处理事件中也处理了拼盘数据和坐标,
那么就会产生race,所以设计上不能出现race.

回到整个puzzle库的设计初衷,不应该关心坐标(特别是我这个坐标设计的太随意),
所以后一个版本去掉坐标

## 一个绿灯版本的思考

- 死锁,竞争,需要万分小心,特别是并发程序(这个版本只有两个协程,也出现了死锁)
- 库越简单越好
  - 第一次详细设计,就是想为提供所有场景下都方便的接口,最后...
  - 回归问题的本质,其实这个puzzle拼盘库只需要提供拼盘数据即可
  - 至于每次移动对应的局部变化,就让外部库或应用程序自己算就行,没必要放在库里
- 后续的复盘/cli程序的调用,放在重构中
- 这个版本的文件拆解,也放在重构中
- 剩下的一个race问题,放在重构中解决
  - go test ./... -v -race

## 简化接口后的重构版本

- 消除了所有的race
- 简化了调用流程,减少了暴露的接口数量
- 简化之后,也没有必要进行文件拆分了,只剩一个了

在这个版本中,用tdd的方法确保了所有的变更都是正确的,
另外testing库好像功能还不够多,测试这块和调试这块还需要加强.
